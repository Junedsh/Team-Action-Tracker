<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Action Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input[type="date"]:in-range::-webkit-datetime-edit-year-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-month-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-day-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-text { 	
            color: transparent; 
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            color: #374151;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.6;
        }
        /* Tooltip for comments on hover */
        [data-tooltip-text]:hover {
            position: relative;
        }
        [data-tooltip-text]:hover::after {
            content: attr(data-tooltip-text);
            position: absolute;
            left: 0;
            transform: translateX(0);
            bottom: 100%;
            margin-bottom: 5px;
            z-index: 10;
            background-color: #1f2937; /* dark gray */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            width: max-content;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Top Navigation Bar -->
    <nav class="bg-slate-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-white">Team Action Tracker</h1>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Task Dashboard</h2>
                    <div class="flex gap-2">
                        <button id="manage-team-btn" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Manage Team
                        </button>
                        <button id="open-add-task-modal-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add New Task
                        </button>
                    </div>
                </div>
                <!-- Summary Cards -->
                <div id="summary-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4"></div>
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <input type="text" id="search-input" placeholder="Search tasks..." class="md:col-span-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                    <select id="filter-owner" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Owner (All)</option>
                    </select>
                    <select id="filter-status" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Status (All)</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Done">Done</option>
                        <option value="Overdue">Overdue</option>
                    </select>
                    <div class="relative">
                        <input type="date" id="filter-date-start" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500">
                        <label for="filter-date-start" class="absolute top-2 left-2 text-gray-400 text-sm pointer-events-none">Start Date</label>
                    </div>
                    <div class="relative">
                        <input type="date" id="filter-date-end" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500">
                         <label for="filter-date-end" class="absolute top-2 left-2 text-gray-400 text-sm pointer-events-none">End Date</label>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="description">Task <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="owner">Owner <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="assignedDate">Assigned Date <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="promiseDate">Promise Date <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days Taken</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="task-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Task</h3>
                <button id="close-task-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="task-form" class="space-y-4">
                <input type="hidden" id="task-id" name="task-id">
                <div>
                    <label for="task-description" class="block text-sm font-medium text-gray-700">Task Description</label>
                    <input type="text" id="task-description" name="task-description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                </div>
                <div>
                    <label for="task-owner" class="block text-sm font-medium text-gray-700">Owner</label>
                    <p id="owner-helper-text" class="text-xs text-gray-500 hidden">Hold Ctrl or Cmd to select multiple owners.</p>
                    <select id="task-owner" name="task-owner" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white"></select>
                </div>
                <div>
                    <label for="promise-date" class="block text-sm font-medium text-gray-700">Promise Date</label>
                    <input type="date" id="promise-date" name="promise-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500">
                </div>
                <div>
                    <label for="task-status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="task-status" name="task-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option>Pending</option>
                        <option>In Progress</option>
                        <option>Done</option>
                    </select>
                </div>
                <div>
                    <label for="task-comments" class="block text-sm font-medium text-gray-700">Comments</label>
                    <textarea id="task-comments" name="task-comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"></textarea>
                </div>
                <button id="modal-submit-btn" type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Add Task
                </button>
            </form>
        </div>
    </div>
    
    <!-- Manage Team Modal -->
    <div id="team-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Manage Team</h3>
                <button id="close-team-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Add Member Form -->
                <div class="md:col-span-1">
                    <h4 class="font-semibold mb-2">Add New Member</h4>
                    <form id="team-form" class="space-y-4">
                         <div>
                            <label for="member-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="member-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="member-designation" class="block text-sm font-medium text-gray-700">Designation</label>
                            <input type="text" id="member-designation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add Member</button>
                    </form>
                </div>
                <!-- Team List -->
                <div class="md:col-span-2">
                     <h4 class="font-semibold mb-2">Current Team</h4>
                     <div class="overflow-y-auto max-h-64 border rounded-md">
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                 <tr>
                                     <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                     <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                                     <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                 </tr>
                             </thead>
                             <tbody id="team-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                         </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc, 
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ELEMENT SELECTORS ---
        const taskTableBody = document.getElementById('task-table-body');
        const searchInput = document.getElementById('search-input');
        const filterOwner = document.getElementById('filter-owner');
        const filterStatus = document.getElementById('filter-status');
        const filterDateStart = document.getElementById('filter-date-start');
        const filterDateEnd = document.getElementById('filter-date-end');
        const summaryCardsContainer = document.getElementById('summary-cards');
        const openTaskModalBtn = document.getElementById('open-add-task-modal-btn');
        const closeTaskModalBtn = document.getElementById('close-task-modal-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const ownerSelect = document.getElementById('task-owner');
        const ownerHelperText = document.getElementById('owner-helper-text');
        const manageTeamBtn = document.getElementById('manage-team-btn');
        const teamModal = document.getElementById('team-modal');
        const closeTeamModalBtn = document.getElementById('close-team-modal-btn');
        const teamForm = document.getElementById('team-form');
        const teamListBody = document.getElementById('team-list-body');

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCwtt4uMlfNF4wcjM82ZM7VJW9Z8JL_6mA",
          authDomain: "team-action-tracker.firebaseapp.com",
          projectId: "team-action-tracker",
          storageBucket: "team-action-tracker.firebasestorage.app",
          messagingSenderId: "733443606163",
          appId: "1:733443606163:web:0128b626cebe722a6faf66"
        };
        const appId = 'team-action-tracker';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- COLLECTION REFERENCES ---
        let tasksCollection, teamCollection;

        // --- DATA STORE ---
        let teamMembers = [];
        let tasks = [];

        // --- STATE MANAGEMENT ---
        let currentFilters = { search: '', owner: 'all', status: 'all', dateStart: null, dateEnd: null };
        let currentSort = { key: 'promiseDate', order: 'asc' };
        
        const initializeFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                // Setup Firestore listeners now that we are sure we're authenticated.
                tasksCollection = collection(db, `/artifacts/${appId}/public/data/tasks`);
                teamCollection = collection(db, `/artifacts/${appId}/public/data/teamMembers`);
                
                onSnapshot(teamCollection, (snapshot) => {
                    teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rerenderAll();
                }, (error) => console.error("Team snapshot error:", error));

                onSnapshot(tasksCollection, (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rerenderAll();
                }, (error) => console.error("Tasks snapshot error:", error));
            } else {
                console.log("User is not authenticated.");
            }
        });


        // --- HELPER & RENDER FUNCTIONS ---
        const isOverdue = (task) => !task.status.includes('Done') && new Date(task.promiseDate + 'T00:00:00') < new Date(new Date().setHours(0,0,0,0));
        const getStatusColors = (task) => {
            if (isOverdue(task)) return { bg: 'bg-red-100', text: 'text-red-800', label: 'Overdue' };
            switch (task.status) {
                case 'Pending': return { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'Pending' };
                case 'In Progress': return { bg: 'bg-blue-100', text: 'text-blue-800', label: 'In Progress' };
                case 'Done': return { bg: 'bg-green-100', text: 'text-green-800', label: 'Done' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-800', label: 'Unknown' };
            }
        };
        const calculateDaysTaken = (task) => {
            if (task.status !== 'Done' || !task.completedDate) return '—';
            const assigned = new Date(task.assignedDate + 'T00:00:00');
            const completed = new Date(task.completedDate + 'T00:00:00');
            if (isNaN(assigned) || isNaN(completed)) return '—';
            const diffTime = Math.abs(completed - assigned);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays === 0 ? 'Today' : `${diffDays}d`;
        };
        const updateSortIcons = () => { document.querySelectorAll('.sortable .sort-icon').forEach(i=>i.textContent='');const activeIcon=document.querySelector(`.sortable[data-sort="${currentSort.key}"] .sort-icon`);if(activeIcon)activeIcon.textContent=currentSort.order==='asc'?' ▲':' ▼'};

        const getFilteredTasks = () => {
            return tasks.filter(task => {
                const searchMatch = task.description.toLowerCase().includes(currentFilters.search.toLowerCase()) || task.owner.toLowerCase().includes(currentFilters.search.toLowerCase());
                const ownerMatch = currentFilters.owner === 'all' || task.owner === currentFilters.owner;
                const statusMatch = currentFilters.status === 'all' || (currentFilters.status === 'Overdue' ? isOverdue(task) : (task.status === currentFilters.status && !isOverdue(task)));
                
                const taskDate = new Date(task.assignedDate + 'T00:00:00');
                const startDate = currentFilters.dateStart ? new Date(currentFilters.dateStart + 'T00:00:00') : null;
                const endDate = currentFilters.dateEnd ? new Date(currentFilters.dateEnd + 'T00:00:00') : null;
                const dateMatch = (!startDate || taskDate >= startDate) && (!endDate || taskDate <= endDate);

                return searchMatch && ownerMatch && statusMatch && dateMatch;
            });
        };

        const renderSummaryCards = () => {
            const relevantTasks = getFilteredTasks();
            const totalTasks = relevantTasks.length;
            const pendingTasks = relevantTasks.filter(t => t.status === 'Pending' && !isOverdue(t)).length;
            const inProgressTasks = relevantTasks.filter(t => t.status === 'In Progress' && !isOverdue(t)).length;
            const overdueTasks = relevantTasks.filter(isOverdue).length;
            summaryCardsContainer.innerHTML = `
                <div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-gray-800">${totalTasks}</p><p class="text-sm text-gray-500">Total Tasks</p></div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-yellow-800">${pendingTasks}</p><p class="text-sm text-yellow-600">Pending</p></div>
                <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-blue-800">${inProgressTasks}</p><p class="text-sm text-blue-600">In Progress</p></div>
                <div class="bg-red-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-red-800">${overdueTasks}</p><p class="text-sm text-red-600">Overdue</p></div>`;
        };

        const populateOwnerDropdowns = () => {
            const currentOwnerFilterValue = filterOwner.value;
            filterOwner.innerHTML = '<option value="all">Filter by Owner (All)</option>';
            ownerSelect.innerHTML = '';

            teamMembers.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                filterOwner.innerHTML += `<option value="${member.name}">${member.name}</option>`;
                ownerSelect.innerHTML += `<option value="${member.name}">${member.name}</option>`;
            });
            filterOwner.value = currentOwnerFilterValue;
        };
        
        const renderTasks = () => {
            let filteredTasks = getFilteredTasks();
            filteredTasks.sort((a, b) => { let valA=a[currentSort.key],valB=b[currentSort.key];if(currentSort.key==='promiseDate'||currentSort.key==='assignedDate'){valA=new Date(valA);valB=new Date(valB)}if(valA<valB)return currentSort.order==='asc'?-1:1;if(valA>valB)return currentSort.order==='asc'?1:-1;return 0});
            
            taskTableBody.innerHTML = '';
            if (filteredTasks.length === 0) {
                taskTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">No tasks match the current filters.</td></tr>`;
                return;
            }
            filteredTasks.forEach(task => {
                const { bg, text, label } = getStatusColors(task);
                const daysTaken = calculateDaysTaken(task);
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const tooltipAttr = task.comments ? `data-tooltip-text="${task.comments.replace(/"/g, '&quot;')}"` : '';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 relative" ${tooltipAttr}>${task.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.owner}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.assignedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.promiseDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${daysTaken}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bg} ${text}">${label}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 flex items-center">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${task.id}">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${task.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>`;
                taskTableBody.appendChild(row);
            });
            attachActionListeners();
            updateSortIcons();
        };
        
        const renderTeamMembers = () => {
            teamListBody.innerHTML = '';
            teamMembers.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                teamListBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 text-sm text-gray-800">${member.name}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${member.designation}</td>
                        <td class="px-4 py-2"><button class="delete-member-btn text-red-600 hover:text-red-900 text-sm" data-id="${member.id}">Delete</button></td>
                    </tr>`;
            });
            document.querySelectorAll('.delete-member-btn').forEach(b => b.onclick = e => deleteTeamMember(e.currentTarget.dataset.id));
        };

        // --- CORE LOGIC & MODAL FUNCTIONS ---
        const rerenderAll = () => { populateOwnerDropdowns(); renderSummaryCards(); renderTasks(); renderTeamMembers(); };
        const attachActionListeners = () => {
            document.querySelectorAll('.delete-btn').forEach(b => b.onclick = e => deleteTask(e.currentTarget.dataset.id));
            document.querySelectorAll('.edit-btn').forEach(b => b.onclick = e => openEditModal(e.currentTarget.dataset.id));
        };
        
        const deleteTask = (id) => deleteDoc(doc(tasksCollection, id));
        const addTeamMember = (name, designation) => addDoc(teamCollection, { name, designation });
        const deleteTeamMember = (id) => deleteDoc(doc(teamCollection, id));
        
        const openAddTaskModal = () => {
            taskForm.reset();
            modalTitle.textContent = 'Add New Task';
            modalSubmitBtn.textContent = 'Add Task';
            document.getElementById('task-id').value = '';
            ownerSelect.multiple = true;
            ownerSelect.classList.add('h-24');
            ownerHelperText.classList.remove('hidden');
            taskModal.classList.remove('hidden');
        };
        const openEditModal = (id) => {
            const task = tasks.find(t => t.id === id); if (!task) return;
            ownerSelect.multiple = false;
            ownerSelect.classList.remove('h-24');
            ownerHelperText.classList.add('hidden');
            modalTitle.textContent = 'Edit Task'; modalSubmitBtn.textContent = 'Save Changes';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-description').value = task.description;
            document.getElementById('task-owner').value = task.owner;
            document.getElementById('promise-date').value = task.promiseDate;
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-comments').value = task.comments;
            taskModal.classList.remove('hidden');
        };

        // --- EVENT HANDLERS ---
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = e.target['task-id'].value;
            const description = e.target['task-description'].value.trim();
            const promiseDate = e.target['promise-date'].value;
            const status = e.target['task-status'].value;
            const comments = e.target['task-comments'].value.trim();

            if (id) { // Editing existing task
                const owner = ownerSelect.value;
                if (!description || !owner || !promiseDate) return;
                const taskRef = doc(tasksCollection, id);
                const taskData = tasks.find(t => t.id === id);
                const wasDone = taskData.status === 'Done';

                await updateDoc(taskRef, {
                    description, owner, promiseDate, status, comments,
                    completedDate: status === 'Done' && !wasDone ? new Date().toISOString().split('T')[0] : (status !== 'Done' && wasDone ? null : taskData.completedDate)
                });
            } else { // Adding new task and splitting if multiple owners
                const selectedOwners = Array.from(ownerSelect.selectedOptions).map(opt => opt.value);
                if (!description || selectedOwners.length === 0 || !promiseDate) return;
                
                const assignedDate = new Date().toISOString().split('T')[0];
                for (const owner of selectedOwners) {
                    await addDoc(tasksCollection, { 
                         description, 
                         owner, 
                         assignedDate, 
                         promiseDate, 
                         status, 
                         comments, 
                         completedDate: status === 'Done' ? assignedDate : null 
                    });
                }
            }
            taskModal.classList.add('hidden');
        });

        teamForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = e.target['member-name'].value.trim();
            const designation = e.target['member-designation'].value.trim();
            if(name && designation) addTeamMember(name, designation);
e.target.reset();
        });

        // Filter Event Listeners
        searchInput.addEventListener('input', e => { currentFilters.search = e.target.value; rerenderAll(); });
        filterOwner.addEventListener('change', e => { currentFilters.owner = e.target.value; rerenderAll(); });
        filterStatus.addEventListener('change', e => { currentFilters.status = e.target.value; rerenderAll(); });
        
        const setupDateInput = (input) => {
            input.addEventListener('change', (e) => {
                const dateVal = e.target.value;
                const label = e.target.nextElementSibling;
                if (label) label.style.display = dateVal ? 'none' : 'block';
                e.target.classList.toggle('text-gray-900', !!dateVal);

                if (e.target.id === 'filter-date-start') currentFilters.dateStart = dateVal || null;
                else if (e.target.id === 'filter-date-end') currentFilters.dateEnd = dateVal || null;
                
                rerenderAll();
            });
        };
        setupDateInput(filterDateStart);
        setupDateInput(filterDateEnd);


        // Sort Event Listener
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => { const sortKey=header.dataset.sort;if(currentSort.key===sortKey){currentSort.order=currentSort.order==='asc'?'desc':'asc'}else{currentSort.key=sortKey;currentSort.order='asc'}renderTasks()});
        });

        // Modal listeners
        openTaskModalBtn.addEventListener('click', openAddTaskModal);
        closeTaskModalBtn.addEventListener('click', () => taskModal.classList.add('hidden'));
        taskModal.addEventListener('click', (e) => { if (e.target === taskModal) taskModal.classList.add('hidden'); });
        manageTeamBtn.addEventListener('click', () => teamModal.classList.remove('hidden'));
        closeTeamModalBtn.addEventListener('click', () => teamModal.classList.add('hidden'));
        teamModal.addEventListener('click', (e) => { if (e.target === teamModal) teamModal.classList.add('hidden'); });

        // --- INITIALIZE APP ---
        initializeFirebase();

    </script>
</body>
</html>

