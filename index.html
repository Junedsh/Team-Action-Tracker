<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Action Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input[type="date"]:in-range::-webkit-datetime-edit-year-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-month-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-day-field, 
        input[type="date"]:in-range::-webkit-datetime-edit-text { 	
            color: transparent; 
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            color: #374151;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.6;
        }
        /* Tooltip for comments on hover */
        [data-tooltip-text]:hover {
            position: relative;
        }
        [data-tooltip-text]:hover::after {
            content: attr(data-tooltip-text);
            position: absolute;
            left: 0;
            transform: translateX(0);
            bottom: 100%;
            margin-bottom: 5px;
            z-index: 10;
            background-color: #1f2937; /* dark gray */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            width: max-content;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            opacity: 1;
        }
        /* Tab Styles */
        .tab-btn.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        /* FullCalendar Customizations */
        :root {
            --fc-border-color: #e5e7eb;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-hover-bg-color: #f9fafb;
        }
        .fc-event {
            cursor: pointer;
        }
        .fc-day-today {
            background: #f0f3ff !important;
        }
        .fc-event-main {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #calendar.week-view-active .fc-event-main {
            white-space: normal !important;
            word-wrap: break-word;
        }
        /* Tippy Tooltip Styles */
        .tippy-box[data-theme~='light'] {
            background-color: #fff;
            color: #333;
            border: 1px solid #ddd;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-slate-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-white">Team Action Tracker</h1>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Task Dashboard</h2>
                    <div class="flex gap-2">
                        <button id="manage-project-btn" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Manage Projects
                        </button>
                        <button id="manage-team-btn" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Manage Team
                        </button>
                        <button id="open-add-task-modal-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add New Task
                        </button>
                    </div>
                </div>
                <div id="summary-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-8 gap-4 items-center">
                    <input type="text" id="search-input" placeholder="Search tasks..." class="md:col-span-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                    <select id="filter-project" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Project (All)</option>
                    </select>
                    <select id="filter-owner" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Owner (All)</option>
                    </select>
                    <select id="filter-priority" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Priority (All)</option>
                        <option>Low</option><option>Medium</option><option>High</option><option>Urgent</option>
                    </select>
                    <select id="filter-status" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white">
                        <option value="all">Filter by Status (All)</option>
                        <option value="Pending">Pending</option><option>In Progress</option><option>Done</option><option>Overdue</option>
                    </select>
                    <div class="relative">
                        <input type="date" id="filter-date-start" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500">
                        <label for="filter-date-start" class="absolute top-2 left-2 text-gray-400 text-sm pointer-events-none">Start Date</label>
                    </div>
                    <div class="relative">
                        <input type="date" id="filter-date-end" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500">
                         <label for="filter-date-end" class="absolute top-2 left-2 text-gray-400 text-sm pointer-events-none">End Date</label>
                    </div>
                </div>
            </div>
             <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="tab-list" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Task List</button>
                    <button id="tab-dashboard" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Visual Dashboard</button>
                    <button id="tab-calendar" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Calendar</button>
                    <button id="tab-project-view" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Project View</button>
                </nav>
            </div>
            <div id="tab-panel-list" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="description">Task <span class="sort-icon"></span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="owner">Owner <span class="sort-icon"></span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="priority">Priority <span class="sort-icon"></span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="assignedDate">Assigned Date <span class="sort-icon"></span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="promiseDate">Promise Date <span class="sort-icon"></span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days Taken</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="task-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
            </div>
             <div id="tab-panel-dashboard" class="p-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-semibold text-center mb-2">Tasks by Status</h3><canvas id="statusChart"></canvas></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-semibold text-center mb-2">Tasks by Priority</h3><canvas id="priorityChart"></canvas></div>
                    <div class="lg:col-span-2 bg-gray-50 p-4 rounded-lg"><h3 class="font-semibold text-center mb-2">Tasks per Owner</h3><canvas id="ownerChart"></canvas></div>
                </div>
            </div>
            <div id="tab-panel-calendar" class="p-6 hidden">
                <div id="calendar"></div>
            </div>
            <div id="tab-panel-project-view" class="p-6 hidden">
                </div>
        </div>
    </main>

    <div id="task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Task</h3><button id="close-task-modal-btn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <form id="task-form" class="space-y-4"><input type="hidden" id="task-id" name="task-id"><div><label for="task-project" class="block text-sm font-medium text-gray-700">Project / Category</label><select id="task-project" name="task-project" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white"></select></div><div><label for="task-description" class="block text-sm font-medium text-gray-700">Task Description</label><input type="text" id="task-description" name="task-description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"></div><div class="grid grid-cols-2 gap-4"><div><label for="task-owner" class="block text-sm font-medium text-gray-700">Owner</label><p id="owner-helper-text" class="text-xs text-gray-500 hidden">Hold Ctrl/Cmd to select multiple.</p><select id="task-owner" name="task-owner" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white"></select></div><div><label for="task-priority" class="block text-sm font-medium text-gray-700">Priority</label><select id="task-priority" name="task-priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white"><option>Low</option><option selected>Medium</option><option>High</option><option>Urgent</option></select></div></div><div class="grid grid-cols-2 gap-4"><div><label for="promise-date" class="block text-sm font-medium text-gray-700">Promise Date</label><input type="date" id="promise-date" name="promise-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border text-gray-500"></div><div><label for="task-status" class="block text-sm font-medium text-gray-700">Status</label><select id="task-status" name="task-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border bg-white"><option>Pending</option><option>In Progress</option><option>Done</option></select></div></div><div><label for="task-comments" class="block text-sm font-medium text-gray-700">Comments</label><textarea id="task-comments" name="task-comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"></textarea></div><button id="modal-submit-btn" type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">Add Task</button></form>
        </div>
    </div>
    
    <div id="team-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-800">Manage Team</h3><button id="close-team-modal-btn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><h4 class="font-semibold mb-2">Add New Member</h4><form id="team-form" class="space-y-4"><div><label for="member-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="member-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></div><div><label for="member-designation" class="block text-sm font-medium text-gray-700">Designation</label><input type="text" id="member-designation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></div><button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add Member</button></form></div><div class="md:col-span-2"><h4 class="font-semibold mb-2">Current Team</h4><div class="overflow-y-auto max-h-64 border rounded-md"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th></tr></thead><tbody id="team-list-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>
        </div>
    </div>
    
    <div id="project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Manage Projects</h3>
                <button id="close-project-modal-btn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-1">
                    <h4 class="font-semibold mb-2">Add New Project</h4>
                    <form id="project-form" class="space-y-4">
                        <div><label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label><input type="text" id="project-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></div>
                        <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add Project</button>
                    </form>
                </div>
                <div class="md:col-span-1">
                    <h4 class="font-semibold mb-2">Current Projects</h4>
                    <div class="overflow-y-auto max-h-64 border rounded-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th></tr></thead>
                            <tbody id="project-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ELEMENT SELECTORS ---
        const taskTableBody = document.getElementById('task-table-body'), searchInput = document.getElementById('search-input'), filterOwner = document.getElementById('filter-owner'), filterStatus = document.getElementById('filter-status'), filterDateStart = document.getElementById('filter-date-start'), filterDateEnd = document.getElementById('filter-date-end'), summaryCardsContainer = document.getElementById('summary-cards'), openTaskModalBtn = document.getElementById('open-add-task-modal-btn'), closeTaskModalBtn = document.getElementById('close-task-modal-btn'), taskModal = document.getElementById('task-modal'), taskForm = document.getElementById('task-form'), modalTitle = document.getElementById('modal-title'), modalSubmitBtn = document.getElementById('modal-submit-btn'), ownerSelect = document.getElementById('task-owner'), ownerHelperText = document.getElementById('owner-helper-text'), manageTeamBtn = document.getElementById('manage-team-btn'), teamModal = document.getElementById('team-modal'), closeTeamModalBtn = document.getElementById('close-team-modal-btn'), teamForm = document.getElementById('team-form'), teamListBody = document.getElementById('team-list-body'), filterProject = document.getElementById('filter-project'), filterPriority = document.getElementById('filter-priority'), manageProjectBtn = document.getElementById('manage-project-btn'), projectModal = document.getElementById('project-modal'), closeProjectModalBtn = document.getElementById('close-project-modal-btn'), projectForm = document.getElementById('project-form'), projectListBody = document.getElementById('project-list-body');
        const tabList = document.getElementById('tab-list'), tabDashboard = document.getElementById('tab-dashboard'), tabCalendar = document.getElementById('tab-calendar'), tabProjectView = document.getElementById('tab-project-view');
        const tabPanelList = document.getElementById('tab-panel-list'), tabPanelDashboard = document.getElementById('tab-panel-dashboard'), tabPanelCalendar = document.getElementById('tab-panel-calendar'), tabPanelProjectView = document.getElementById('tab-panel-project-view');
        const calendarEl = document.getElementById('calendar');

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCwtt4uMlfNF4wcjM82ZM7VJW9Z8JL_6mA",
          authDomain: "team-action-tracker.firebaseapp.com",
          projectId: "team-action-tracker",
          storageBucket: "team-action-tracker.firebasestorage.app",
          messagingSenderId: "733443606163",
          appId: "1:733443606163:web:0128b626cebe722a6faf66"
        };
        const appId = 'team-action-tracker';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- COLLECTION REFERENCES ---
        let tasksCollection, teamCollection, projectsCollection;

        // --- DATA STORE & CHART/CALENDAR INSTANCES ---
        let teamMembers = [], tasks = [], projects = [];
        let statusChart, priorityChart, ownerChart, calendar;
        Chart.register(ChartDataLabels);

        // --- STATE MANAGEMENT ---
        let currentFilters = { search: '', owner: 'all', status: 'all', dateStart: null, dateEnd: null, project: 'all', priority: 'all' };
        let currentSort = { key: 'promiseDate', order: 'asc' };
        
        const initializeFirebase = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (error) { console.error("Authentication failed:", error); } };

        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                tasksCollection = collection(db, `/artifacts/${appId}/public/data/tasks`);
                teamCollection = collection(db, `/artifacts/${appId}/public/data/teamMembers`);
                projectsCollection = collection(db, `/artifacts/${appId}/public/data/projects`);
                
                onSnapshot(teamCollection, (snapshot) => { teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); rerenderAll(); }, (error) => console.error("Team snapshot error:", error));
                onSnapshot(tasksCollection, (snapshot) => { tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); rerenderAll(); }, (error) => console.error("Tasks snapshot error:", error));
                onSnapshot(projectsCollection, (snapshot) => { projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); rerenderAll(); }, (error) => console.error("Projects snapshot error:", error));
            } else { console.log("User is not authenticated."); }
        });

        // --- HELPER & RENDER FUNCTIONS ---
        const formatDate = (date) => { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
        const isOverdue = (task) => !task.status.includes('Done') && new Date(task.promiseDate + 'T00:00:00') < new Date(new Date().setHours(0,0,0,0));
        const getStatusColors = (task) => { if (isOverdue(task)) return { bg: 'bg-red-100', text: 'text-red-800', label: 'Overdue', calendarColor: '#EF4444' }; switch (task.status) { case 'Pending': return { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'Pending', calendarColor: '#FBBF24' }; case 'In Progress': return { bg: 'bg-blue-100', text: 'text-blue-800', label: 'In Progress', calendarColor: '#3B82F6' }; case 'Done': return { bg: 'bg-green-100', text: 'text-green-800', label: 'Done', calendarColor: '#10B981' }; default: return { bg: 'bg-gray-100', text: 'text-gray-800', label: 'Unknown', calendarColor: '#6B7280' }; } };
        const getPriorityColors = (priority) => { switch (priority) { case 'Urgent': return 'bg-red-500 text-white'; case 'High': return 'bg-orange-500 text-white'; case 'Medium': return 'bg-blue-500 text-white'; case 'Low': return 'bg-gray-500 text-white'; default: return 'bg-gray-400 text-white'; } };
        const calculateDaysTaken = (task) => { if (task.status !== 'Done' || !task.completedDate) return '—'; const assigned = new Date(task.assignedDate + 'T00:00:00'); const completed = new Date(task.completedDate + 'T00:00:00'); if (isNaN(assigned) || isNaN(completed)) return '—'; const diffTime = Math.abs(completed - assigned); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return diffDays === 0 ? 'Today' : `${diffDays}d`; };
        const calculatePromiseDifference = (task) => { if (!task.assignedDate || !task.promiseDate) return 'N/A'; const assigned = new Date(task.assignedDate); const promise = new Date(task.promiseDate); if (isNaN(assigned.getTime()) || isNaN(promise.getTime())) return 'N/A'; const diffTime = promise.getTime() - assigned.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; return `${diffDays} day(s)`; };
        const updateSortIcons = () => { document.querySelectorAll('.sortable .sort-icon').forEach(i=>i.textContent='');const activeIcon=document.querySelector(`.sortable[data-sort="${currentSort.key}"] .sort-icon`);if(activeIcon)activeIcon.textContent=currentSort.order==='asc'?' ▲':' ▼'};
        const getFilteredTasks = () => { return tasks.filter(task => { const searchMatch = task.description.toLowerCase().includes(currentFilters.search.toLowerCase()) || (task.project && task.project.toLowerCase().includes(currentFilters.search.toLowerCase())) || task.owner.toLowerCase().includes(currentFilters.search.toLowerCase()); const ownerMatch = currentFilters.owner === 'all' || task.owner === currentFilters.owner; const statusMatch = currentFilters.status === 'all' || (currentFilters.status === 'Overdue' ? isOverdue(task) : (task.status === currentFilters.status && !isOverdue(task))); const projectMatch = currentFilters.project === 'all' || task.project === currentFilters.project; const priorityMatch = currentFilters.priority === 'all' || task.priority === currentFilters.priority; const taskDate = new Date(task.assignedDate + 'T00:00:00'); const startDate = currentFilters.dateStart ? new Date(currentFilters.dateStart + 'T00:00:00') : null; const endDate = currentFilters.dateEnd ? new Date(currentFilters.dateEnd + 'T00:00:00') : null; const dateMatch = (!startDate || taskDate >= startDate) && (!endDate || taskDate <= endDate); return searchMatch && ownerMatch && statusMatch && dateMatch && projectMatch && priorityMatch; }); };
        const renderSummaryCards = () => { const relevantTasks = getFilteredTasks(); const totalTasks = relevantTasks.length; const pendingTasks = relevantTasks.filter(t => t.status === 'Pending' && !isOverdue(t)).length; const inProgressTasks = relevantTasks.filter(t => t.status === 'In Progress' && !isOverdue(t)).length; const overdueTasks = relevantTasks.filter(isOverdue).length; summaryCardsContainer.innerHTML = `<div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-gray-800">${totalTasks}</p><p class="text-sm text-gray-500">Total Tasks</p></div><div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-yellow-800">${pendingTasks}</p><p class="text-sm text-yellow-600">Pending</p></div><div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-blue-800">${inProgressTasks}</p><p class="text-sm text-blue-600">In Progress</p></div><div class="bg-red-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-red-800">${overdueTasks}</p><p class="text-sm text-red-600">Overdue</p></div>`; };
        
        const populateProjectFilter = () => { const currentProjectFilterValue = filterProject.value; filterProject.innerHTML = '<option value="all">Filter by Project (All)</option>'; projects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => { filterProject.innerHTML += `<option value="${project.name}">${project.name}</option>`; }); filterProject.value = currentProjectFilterValue; };
        const populateTaskProjectDropdown = () => { const taskProjectSelect = document.getElementById('task-project'); taskProjectSelect.innerHTML = '<option value="">-- Select a Project --</option>'; projects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => { taskProjectSelect.innerHTML += `<option value="${project.name}">${project.name}</option>`; }); };
        const populateOwnerDropdowns = () => { const currentOwnerFilterValue = filterOwner.value; filterOwner.innerHTML = '<option value="all">Filter by Owner (All)</option>'; ownerSelect.innerHTML = ''; teamMembers.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => { filterOwner.innerHTML += `<option value="${member.name}">${member.name}</option>`; ownerSelect.innerHTML += `<option value="${member.name}">${member.name}</option>`; }); filterOwner.value = currentOwnerFilterValue; };
        
        const renderTasks = () => { let filteredTasks = getFilteredTasks(); filteredTasks.sort((a, b) => { let valA=a[currentSort.key],valB=b[currentSort.key];if(currentSort.key==='promiseDate'||currentSort.key==='assignedDate'){valA=new Date(valA);valB=new Date(valB)}if(valA<valB)return currentSort.order==='asc'?-1:1;if(valA>valB)return currentSort.order==='asc'?1:-1;return 0}); taskTableBody.innerHTML = ''; if (filteredTasks.length === 0) { taskTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-4">No tasks match the current filters.</td></tr>`; return; } filteredTasks.forEach(task => { const { bg, text, label } = getStatusColors(task); const priorityColor = getPriorityColors(task.priority); const daysTaken = calculateDaysTaken(task); const row = document.createElement('tr'); row.className = 'hover:bg-gray-50 transition-colors'; const tooltipAttr = task.comments ? `data-tooltip-text="${task.comments.replace(/"/g, '&quot;')}"` : ''; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 relative" ${tooltipAttr}>${task.description}<div class="text-xs text-gray-500">${task.project || ''}</div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.owner}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${priorityColor}">${task.priority || 'Medium'}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.assignedDate}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.promiseDate}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${daysTaken}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bg} ${text}">${label}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 flex items-center"><button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${task.id}">Edit</button><button class="delete-btn text-red-600 hover:text-red-900" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h--3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td>`; taskTableBody.appendChild(row); }); attachActionListeners(); updateSortIcons(); };
        const renderTeamMembers = () => { teamListBody.innerHTML = ''; teamMembers.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => { teamListBody.innerHTML += `<tr><td class="px-4 py-2 text-sm text-gray-800">${member.name}</td><td class="px-4 py-2 text-sm text-gray-500">${member.designation}</td><td class="px-4 py-2"><button class="delete-member-btn text-red-600 hover:text-red-900 text-sm" data-id="${member.id}">Delete</button></td></tr>`; }); document.querySelectorAll('.delete-member-btn').forEach(b => b.onclick = e => deleteTeamMember(e.currentTarget.dataset.id)); };
        const renderProjects = () => { projectListBody.innerHTML = ''; projects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => { projectListBody.innerHTML += `<tr><td class="px-4 py-2 text-sm text-gray-800">${project.name}</td><td class="px-4 py-2"><button class="delete-project-btn text-red-600 hover:text-red-900 text-sm" data-id="${project.id}">Delete</button></td></tr>`; }); document.querySelectorAll('.delete-project-btn').forEach(b => b.onclick = e => deleteProject(e.currentTarget.dataset.id)); };
        const renderCharts = () => { const filteredTasks = getFilteredTasks(); const totalTasks = filteredTasks.length; const statusCounts = { Pending: 0, 'In Progress': 0, Done: 0, Overdue: 0 }; filteredTasks.forEach(task => { if(isOverdue(task)) statusCounts.Overdue++; else statusCounts[task.status]++; }); if(statusChart) statusChart.destroy(); statusChart = new Chart(document.getElementById('statusChart'), { type: 'pie', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#FBBF24', '#3B82F6', '#10B981', '#EF4444'] }] }, options: { plugins: { datalabels: { formatter: (value, ctx) => { if (value === 0) return ''; let percentage = totalTasks > 0 ? (value / totalTasks * 100).toFixed(1) + '%' : '0.0%'; return `${value} (${percentage})`; }, color: '#fff', font: { weight: 'bold' } } } } }); const priorityCounts = { Low: 0, Medium: 0, High: 0, Urgent: 0 }; filteredTasks.forEach(task => priorityCounts[task.priority || 'Medium']++); if(priorityChart) priorityChart.destroy(); priorityChart = new Chart(document.getElementById('priorityChart'), { type: 'pie', data: { labels: Object.keys(priorityCounts), datasets: [{ data: Object.values(priorityCounts), backgroundColor: ['#6B7280', '#3B82F6', '#F97316', '#EF4444'] }] }, options: { plugins: { datalabels: { formatter: (value, ctx) => { if (value === 0) return ''; let percentage = totalTasks > 0 ? (value / totalTasks * 100).toFixed(1) + '%' : '0.0%'; return `${value} (${percentage})`; }, color: '#fff', font: { weight: 'bold' } } } } }); const ownerCounts = {}; filteredTasks.forEach(task => { ownerCounts[task.owner] = (ownerCounts[task.owner] || 0) + 1; }); if(ownerChart) ownerChart.destroy(); ownerChart = new Chart(document.getElementById('ownerChart'), { type: 'bar', data: { labels: Object.keys(ownerCounts), datasets: [{ label: 'Tasks', data: Object.values(ownerCounts), backgroundColor: '#3B82F6' }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', font: { weight: 'bold' } } } } }); };
        const renderCalendar = () => { const filteredTasks = getFilteredTasks(); const events = filteredTasks.map(task => ({ id: task.id, title: `${task.owner}: ${task.description}`, start: task.promiseDate, allDay: true, color: getStatusColors(task).calendarColor, extendedProps: { task: task } })); if (calendar) { calendar.removeAllEvents(); calendar.addEventSource(events); } };
        
        const renderProjectView = () => {
            const container = document.getElementById('tab-panel-project-view');
            let filteredTasks = getFilteredTasks();
            if (filteredTasks.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8">No tasks to display based on current filters.</p>`;
                return;
            }
            const tasksByProject = filteredTasks.reduce((acc, task) => {
                const project = task.project || 'Uncategorized';
                const date = task.assignedDate;
                if (!acc[project]) acc[project] = {};
                if (!acc[project][date]) acc[project][date] = [];
                acc[project][date].push(task);
                return acc;
            }, {});
            let html = '<div class="space-y-8">';
            const sortedProjects = Object.keys(tasksByProject).sort();
            for (const project of sortedProjects) {
                html += `<div class="bg-gray-50 rounded-lg p-4 sm:p-6"><h3 class="text-lg font-bold text-indigo-700 mb-4 border-b border-gray-200 pb-2">${project}</h3><div class="space-y-4">`;
                const tasksByDate = tasksByProject[project];
                const sortedDates = Object.keys(tasksByDate).sort();
                for (const date of sortedDates) {
                    html += `<div class="pl-2"><h4 class="font-semibold text-gray-700 mb-2">${new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>`;
                    html += '<ul class="divide-y divide-gray-200 bg-white rounded-md shadow-sm">';
                    tasksByDate[date].forEach(task => {
                        const { bg, text, label } = getStatusColors(task);
                        html += `
                            <li class="px-4 py-2 flex items-center justify-between hover:bg-gray-50 text-sm">
                                <div class="flex-grow truncate pr-4">
                                    <span class="font-medium text-gray-900">${task.description}</span>
                                    <span class="ml-2 text-gray-500 text-xs">(Owner: ${task.owner} &bull; Due: ${task.promiseDate})</span>
                                </div>
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${bg} ${text} flex-shrink-0">${label}</span>
                            </li>`;
                    });
                    html += '</ul></div>';
                }
                html += `</div></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        };

        // --- CORE LOGIC & MODAL FUNCTIONS ---
        const rerenderAll = () => { populateOwnerDropdowns(); populateProjectFilter(); populateTaskProjectDropdown(); renderSummaryCards(); renderTasks(); renderTeamMembers(); renderProjects(); renderCharts(); renderCalendar(); renderProjectView(); };
        const attachActionListeners = () => { document.querySelectorAll('.delete-btn').forEach(b => b.onclick = e => deleteTask(e.currentTarget.dataset.id)); document.querySelectorAll('.edit-btn').forEach(b => b.onclick = e => openEditModal(e.currentTarget.dataset.id)); };
        const deleteTask = (id) => deleteDoc(doc(tasksCollection, id));
        const addTeamMember = (name, designation) => addDoc(teamCollection, { name, designation });
        const deleteTeamMember = (id) => deleteDoc(doc(teamCollection, id));
        const addProject = (name) => addDoc(projectsCollection, { name });
        const deleteProject = (id) => deleteDoc(doc(projectsCollection, id));
        
        const openAddTaskModal = () => { taskForm.reset(); const promiseDateInput = document.getElementById('promise-date'); const today = new Date(); today.setDate(today.getDate() + 2); promiseDateInput.value = formatDate(today); modalTitle.textContent = 'Add New Task'; modalSubmitBtn.textContent = 'Add Task'; document.getElementById('task-id').value = ''; ownerSelect.multiple = true; ownerSelect.classList.add('h-24'); ownerHelperText.classList.remove('hidden'); taskModal.classList.remove('hidden'); };
        const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task) return; ownerSelect.multiple = false; ownerSelect.classList.remove('h-24'); ownerHelperText.classList.add('hidden'); modalTitle.textContent = 'Edit Task'; modalSubmitBtn.textContent = 'Save Changes'; document.getElementById('task-id').value = task.id; document.getElementById('task-project').value = task.project || ''; document.getElementById('task-description').value = task.description; document.getElementById('task-owner').value = task.owner; document.getElementById('task-priority').value = task.priority || 'Medium'; document.getElementById('promise-date').value = task.promiseDate; document.getElementById('task-status').value = task.status; document.getElementById('task-comments').value = task.comments; taskModal.classList.remove('hidden'); };

        // --- EVENT HANDLERS ---
        taskForm.addEventListener('submit', async (e) => { e.preventDefault(); const id = e.target['task-id'].value; const project = e.target['task-project'].value.trim(); const description = e.target['task-description'].value.trim(); const priority = e.target['task-priority'].value; const promiseDate = e.target['promise-date'].value; const status = e.target['task-status'].value; const comments = e.target['task-comments'].value.trim(); if (id) { const owner = ownerSelect.value; if (!description || !owner || !promiseDate) return; const taskRef = doc(tasksCollection, id); const taskData = tasks.find(t => t.id === id); const wasDone = taskData.status === 'Done'; await updateDoc(taskRef, { project, description, owner, priority, promiseDate, status, comments, completedDate: status === 'Done' && !wasDone ? new Date().toISOString().split('T')[0] : (status !== 'Done' && wasDone ? null : taskData.completedDate) }); } else { const selectedOwners = Array.from(ownerSelect.selectedOptions).map(opt => opt.value); if (!description || selectedOwners.length === 0 || !promiseDate) return; const assignedDate = new Date().toISOString().split('T')[0]; for (const owner of selectedOwners) { await addDoc(tasksCollection, { project, description, owner, priority, assignedDate, promiseDate, status, comments, completedDate: status === 'Done' ? assignedDate : null }); } } taskModal.classList.add('hidden'); });
        teamForm.addEventListener('submit', e => { e.preventDefault(); const name = e.target['member-name'].value.trim(); const designation = e.target['member-designation'].value.trim(); if(name && designation) addTeamMember(name, designation); e.target.reset(); });
        projectForm.addEventListener('submit', e => { e.preventDefault(); const name = e.target['project-name'].value.trim(); if(name) addProject(name); e.target.reset(); });
        searchInput.addEventListener('input', e => { currentFilters.search = e.target.value; rerenderAll(); });
        filterOwner.addEventListener('change', e => { currentFilters.owner = e.target.value; rerenderAll(); });
        filterStatus.addEventListener('change', e => { currentFilters.status = e.target.value; rerenderAll(); });
        filterProject.addEventListener('change', e => { currentFilters.project = e.target.value; rerenderAll(); });
        filterPriority.addEventListener('change', e => { currentFilters.priority = e.target.value; rerenderAll(); });
        
        const setupDateInput = (input) => { input.addEventListener('change', (e) => { const dateVal = e.target.value; const label = e.target.nextElementSibling; if (label) label.style.display = dateVal ? 'none' : 'block'; e.target.classList.toggle('text-gray-900', !!dateVal); if (e.target.id === 'filter-date-start') currentFilters.dateStart = dateVal || null; else if (e.target.id === 'filter-date-end') currentFilters.dateEnd = dateVal || null; rerenderAll(); }); };
        setupDateInput(filterDateStart); setupDateInput(filterDateEnd);
        document.querySelectorAll('.sortable').forEach(header => { header.addEventListener('click', () => { const sortKey=header.dataset.sort;if(currentSort.key===sortKey){currentSort.order=currentSort.order==='asc'?'desc':'asc'}else{currentSort.key=sortKey;currentSort.order='asc'}renderTasks()}); });

        // Tab Event Listeners
        const switchTab = (activeTab) => { const tabs = { list: tabList, dashboard: tabDashboard, calendar: tabCalendar, projectView: tabProjectView }; const panels = { list: tabPanelList, dashboard: tabPanelDashboard, calendar: tabPanelCalendar, projectView: tabPanelProjectView }; Object.keys(tabs).forEach(key => { const isActive = key === activeTab; tabs[key].classList.toggle('active', isActive); panels[key].classList.toggle('hidden', !isActive); }); if (activeTab === 'calendar' && calendar) calendar.render(); };
        tabList.addEventListener('click', () => switchTab('list'));
        tabDashboard.addEventListener('click', () => switchTab('dashboard'));
        tabCalendar.addEventListener('click', () => switchTab('calendar'));
        tabProjectView.addEventListener('click', () => switchTab('projectView'));

        // Modal listeners
        openTaskModalBtn.addEventListener('click', openAddTaskModal);
        closeTaskModalBtn.addEventListener('click', () => taskModal.classList.add('hidden'));
        taskModal.addEventListener('click', (e) => { if (e.target === taskModal) taskModal.classList.add('hidden'); });
        manageTeamBtn.addEventListener('click', () => teamModal.classList.remove('hidden'));
        closeTeamModalBtn.addEventListener('click', () => teamModal.classList.add('hidden'));
        teamModal.addEventListener('click', (e) => { if (e.target === teamModal) teamModal.classList.add('hidden'); });
        manageProjectBtn.addEventListener('click', () => projectModal.classList.remove('hidden'));
        closeProjectModalBtn.addEventListener('click', () => projectModal.classList.add('hidden'));
        projectModal.addEventListener('click', (e) => { if (e.target === projectModal) projectModal.classList.add('hidden'); });
        
        const setDefaultDateFilters = () => { const now = new Date(); const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1); const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0); const startDate = formatDate(firstDayOfMonth); const endDate = formatDate(lastDayOfMonth); filterDateStart.value = startDate; filterDateEnd.value = endDate; currentFilters.dateStart = startDate; currentFilters.dateEnd = endDate; filterDateStart.nextElementSibling.style.display = 'none'; filterDateStart.classList.add('text-gray-900'); filterDateEnd.nextElementSibling.style.display = 'none'; filterDateEnd.classList.add('text-gray-900'); };
        
        // --- INITIALIZE APP & CALENDAR ---
        const initializeCalendar = () => { calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek,listWeek' }, events: [], height: 'auto', views: { dayGridMonth: { dayMaxEvents: true }, dayGridWeek: { dayMaxEvents: false } }, viewDidMount: function(info) { if (info.view.type === 'dayGridWeek') { calendarEl.classList.add('week-view-active'); } else { calendarEl.classList.remove('week-view-active'); } }, eventClick: function(info) { const taskId = info.event.extendedProps.task.id; openEditModal(taskId); }, eventDidMount: function(info) { const task = info.event.extendedProps.task; if (!task) return; const promiseDiff = calculatePromiseDifference(task); tippy(info.el, { content: `<div class="text-left p-1"><p class="font-bold mb-1">${info.event.title}</p><p class="text-xs"><span class="font-semibold">Assigned:</span> ${task.assignedDate}</p><p class="text-xs"><span class="font-semibold">Promise:</span> ${task.promiseDate}</p><p class="text-xs"><span class="font-semibold">Duration:</span> ${promiseDiff}</p></div>`, allowHTML: true, theme: 'light', }); } }); calendar.render(); };
        setDefaultDateFilters();
        initializeFirebase();
        initializeCalendar();
        switchTab('list');
    </script>
</body>
</html>
